<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pure Analyzer v12.7</title>
    <style>
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: sans-serif; touch-action: none; }
        canvas { display: block; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #000; z-index: 100;
        }
        .start-btn {
            padding: 18px 45px; font-size: 16px; color: #00f2fe; background: rgba(0, 242, 254, 0.05);
            border: 2px solid #00f2fe; border-radius: 50px; cursor: pointer; font-weight: bold;
        }
        #dashboard {
            position: absolute; bottom: -130px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; background: rgba(10, 10, 25, 0.95);
            backdrop-filter: blur(20px); border-radius: 20px 20px 0 0; padding: 15px; transition: 0.4s; z-index: 50;
            border-top: 1px solid rgba(0, 242, 254, 0.4);
        }
        #dashboard.active { bottom: 0; }
        .tab-handle {
            position: absolute; top: -35px; left: 50%; transform: translateX(-50%);
            background: rgba(10, 10, 25, 0.95); padding: 5px 25px; border-radius: 12px 12px 0 0;
            font-size: 11px; color: #00f2fe; cursor: pointer; border: 1px solid rgba(0, 242, 254, 0.4); border-bottom: none;
        }
        .control-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; font-size: 11px; }
        .toggle-btn {
            padding: 6px 12px; font-size: 10px; background: #222; border: 1px solid #444; color: #666; border-radius: 5px; cursor: pointer;
        }
        .toggle-btn.active { background: #00f2fe; color: #000; border-color: #00f2fe; font-weight: bold; }
        input[type="range"] { flex: 1; margin-left: 10px; accent-color: #00f2fe; }
    </style>
</head>
<body>

<div id="overlay">
    <button id="startBtn" class="start-btn">LAUNCH PURE ENGINE v12.7</button>
</div>

<div id="dashboard">
    <div class="tab-handle" onclick="toggleDash()">DASHBOARD ▲</div>
    <div class="control-row">
        <span>A-WEIGHTING (聴感補正)</span>
        <button id="weightToggle" class="toggle-btn" onclick="toggleWeight()">OFF</button>
    </div>
    <div class="control-row">
        <span>SENSITIVITY</span>
        <input type="range" id="sensSlider" min="1.0" max="10.0" step="0.1" value="2.5">
    </div>
</div>

<canvas id="waveCanvas"></canvas>

<script>
const canvas = document.getElementById('waveCanvas');
const ctx = canvas.getContext('2d');
const startBtn = document.getElementById('startBtn');

let audioCtx, analyser, dataArray, sourceNode;
let isRunning = false, octaveBands = [], useWeight = false;

function toggleDash() { document.getElementById('dashboard').classList.toggle('active'); }
function toggleWeight() {
    useWeight = !useWeight;
    const btn = document.getElementById('weightToggle');
    btn.innerText = useWeight ? "ON" : "OFF";
    btn.className = useWeight ? "toggle-btn active" : "toggle-btn";
}

startBtn.onclick = async () => {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (audioCtx.state === 'suspended') await audioCtx.resume();

        sourceNode = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 8192; 
        // 俊敏な反応のため、スムージングを大幅に下げる(0.7 -> 0.45)
        analyser.smoothingTimeConstant = 0.45;
        sourceNode.connect(analyser);
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        document.getElementById('overlay').style.display = 'none';
        isRunning = true;
        resize();
        animate();
    } catch (err) { alert("Error: " + err); }
};

function getAWeighting(f) {
    if (f <= 20) return -50;
    const f2 = f * f;
    const rA = (148693636 * f2 * f2) / ((f2 + 424.36) * Math.sqrt((f2 + 11599.29) * (f2 + 544496.41)) * (f2 + 148693636));
    return 20 * Math.log10(rA) + 2.0;
}

function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    setupOctaveBands();
}

function setupOctaveBands() {
    octaveBands = [];
    const sampleRate = audioCtx ? audioCtx.sampleRate : 44100;
    const fftSize = 8192;
    let currentFreq = 20; // 20Hzから開始
    const bandsPerOctave = 3; 
    
    while (currentFreq < sampleRate / 2.2) {
        const fLower = currentFreq / Math.pow(2, 1 / (2 * bandsPerOctave));
        const fUpper = currentFreq * Math.pow(2, 1 / (2 * bandsPerOctave));
        const idxStart = Math.max(1, Math.floor(fLower * fftSize / sampleRate));
        const idxEnd = Math.ceil(fUpper * fftSize / sampleRate);
        octaveBands.push({ freq: currentFreq, idxStart, idxEnd, weight: getAWeighting(currentFreq) });
        currentFreq *= Math.pow(2, 1 / bandsPerOctave);
    }
}

function animate() {
    if (!isRunning) return;
    requestAnimationFrame(animate);
    analyser.getByteFrequencyData(dataArray);

    // 背景描画（より黒を強調）
    ctx.globalCompositeOperation = 'source-over';
    ctx.fillStyle = 'rgba(0, 0, 5, 0.4)';
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    const baseY = canvas.height * 0.7;
    const sens = parseFloat(document.getElementById('sensSlider').value);
    const barWidth = Math.max(3, (canvas.width / octaveBands.length) * 0.7);
    const gap = (canvas.width - (barWidth * octaveBands.length)) / (octaveBands.length + 1);

    for (let i = 0; i < octaveBands.length; i++) {
        const band = octaveBands[i];
        let sum = 0, count = 0;
        for (let j = band.idxStart; j <= band.idxEnd; j++) {
            sum += dataArray[j];
            count++;
        }
        const rawVal = count > 0 ? sum / count : 0;
        
        // --- 補正の適用 ---
        let finalVal = rawVal;
        if (useWeight) {
            finalVal = Math.max(0, rawVal + band.weight);
        }

        let h = (finalVal / 255) * canvas.height * 0.8 * sens;
        h = Math.max(2, Math.min(h, canvas.height * 0.9));

        const x = gap + i * (barWidth + gap);
        const relPos = i / octaveBands.length;
        const hue = 280 + relPos * 70; 

        // 床面反射
        ctx.fillStyle = `hsla(${hue}, 100%, 50%, 0.15)`;
        ctx.fillRect(x, baseY + 2, barWidth, h * 0.3);

        // メインバー
        const grd = ctx.createLinearGradient(x, baseY - h, x, baseY);
        grd.addColorStop(0, `hsla(${hue}, 100%, 85%, 0.9)`);
        grd.addColorStop(1, `hsla(${hue}, 100%, 30%, 0.1)`);
        ctx.fillStyle = grd;
        ctx.fillRect(x, baseY - h, barWidth, h);

        // 先端の輝き（加算合成）
        ctx.globalCompositeOperation = 'lighter';
        ctx.fillStyle = `hsla(${hue}, 100%, 95%, 0.6)`;
        ctx.beginPath();
        ctx.arc(x + barWidth/2, baseY - h, barWidth * 0.9, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalCompositeOperation = 'source-over';
    }
}
window.addEventListener('resize', resize);
</script>
</body>
</html>
