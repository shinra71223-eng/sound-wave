<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Singularity v18.1</title>
    <style>
        body { margin: 0; background: #000; color: white; overflow: hidden; font-family: sans-serif; }
        canvas { display: block; }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            background: #000; z-index: 100;
        }
        .start-btn {
            padding: 18px 45px; color: #fff; background: transparent;
            border: 1px solid #00f2fe; border-radius: 4px; font-weight: bold; cursor: pointer;
            letter-spacing: 4px; box-shadow: 0 0 15px rgba(0, 242, 254, 0.3);
        }
        #ui-layer {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            width: 85%; max-width: 400px; z-index: 50; background: rgba(0,0,0,0.8); 
            padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);
        }
        .label { font-size: 10px; color: #00f2fe; margin-bottom: 5px; font-weight: bold; letter-spacing: 1px;}
    </style>
</head>
<body>

<div id="overlay">
    <button id="startBtn" class="start-btn">IGNITE v18.1</button>
</div>

<div id="ui-layer" style="display:none;">
    <div class="label">AUDIO SENSITIVITY</div>
    <input type="range" id="sensSlider" min="1" max="60" step="0.1" value="25">
</div>

<canvas id="waveCanvas"></canvas>

<script>
const canvas = document.getElementById('waveCanvas');
const ctx = canvas.getContext('2d', { alpha: false });
let audioCtx, analyser, dataArray, isRunning = false;
let bands = [], charge = 0, flash = 0, shockwave = 0, rayLife = 0, lastCoreSize = 0;
let vocalSustainFrames = 0;
const shockwaves = [];

const MAX_P = 800;
const pPool = Array.from({ length: MAX_P }, () => ({ x:0, y:0, vx:0, vy:0, life:0, hue:0, active:false }));

// --- [数学的蓄積パラメーター] ---
const CHARGE_THRESHOLD = 50;  // 充電開始しきい値 (T)
const CRITICAL_POINT = 120;   // 臨界点 (C_max)
const CHARGE_RATE = 0.5;      // 蓄積レート (R_charge)
const DECAY_RATE = 0.08;      // 減衰レート (R_decay)
const VOCAL_TRIGGER_VAL = 190; // 爆発点火ボーカル値
const VOCAL_SUSTAIN_VAL = 150; // 衝撃波放出ボーカル値

function spawn(x, y, hue, vx, vy) {
    const p = pPool.find(p => !p.active) || pPool[0];
    p.active = true; p.x = x; p.y = y; p.vx = vx; p.vy = vy;
    p.life = 1.0; p.hue = hue;
}

document.getElementById('startBtn').onclick = async () => {
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const source = audioCtx.createMediaStreamSource(stream);
        analyser = audioCtx.createAnalyser();
        analyser.
